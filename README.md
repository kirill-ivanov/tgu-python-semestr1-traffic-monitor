# Веб-приложение для отслеживания движения транспорта на видеопотоке.

## Задача:
- Создание backend с использованием FastApi и OpenCV для анализа видеопотока
- Определение типов объектов и подсчет объектов определенных типов
- Разработка frontend на VueJS для отображения видеопотока и отметки движущихся объектов (транспорта).
- Генерация уведомлений пользователям о плотном движении транспорта
- Классификация в кадре разного типа транспорта (авто, автобус,...)

## UML-диаграмма
![UML](/doc/uml_giagram.png)

## Описание приложения:
Приложение разбито на 3 модуля:
### 1. alg (Алгоритм) [Запускается через main в файле alg.py]
Алгоритм, которой с помощью OpenCV и модели обнаружения объектов в реальном времени YOLOv4:
- анализирует видеопоток (может быть как url с камеры rtsp, так и сохраненное видео)
- идентифицирует нужные объекты (можно задать типа, которые хотим находить в конфигурационном файле приложения)
- сохранение в БД sqlite информации в единицу времени по каждому типу
- при достижении порога значений - формируется информация об уведомлении (затор, пробка). Пока это просто запись в БД
- сохранение картинки для фронтенд с объектами, которые удалось определить. Решением с сохранением в картинку вместо сохранения видео было выбрано намеренно, так как является более простым и легким для отображения и воспроизведения в рамках одной системы.

### 2. backend [Запускается командой uvicorn main:app --reload]
Модуль, написанный для FastApi, предоставляющий Rest-сервисы для работы с данными, сгенерированными алгоритмом

### 3. frontend
Интерфейс написан на VueJS. Исходники находятся в папке frontend. Далее они были собраны с помощью NodeJs
```
npm run build
```
Собранные файлы были сохранены в папку /backend/src/web/public и были примонтированы вместе с rest-сервисами как static-страницы.

***

## Интерфейс
В интерфейсе реализовано 3 страницы:
- Онлайн. Отображение текущей обработанной "картинки" с камеры с маркировкой найденных объектов
  ![Страница Online](/doc/online.png)
- Уведомления. Страница со сформированными уведомлениями. Можно отфильтровать по дате и типу
  ![Страница уведомлений](/doc/alert.png)
- Статистика. Страница со статистикой по найденным объектам. Можно отфильтровать по дате, сгруппировать по часу или дню
    ![Страница статистики](/doc/stat1.png)
- ![Страница статистики. Группировка по часу](/doc/stat3.png)
- ![Страница статистики. Группировка по дню](/doc/stat2.png)


## Алгоритм определения объектов
Используется датасет нейронной сети YOLOv4. В конфигурационном файле config.py задаются типы, которые буду определяться на видео.
В качестве источника может быть как видео-поток (rtps), так и сохраненное видео. Путь к потоку или видео указывается в config.py. В качестве примере сохранил видео с камеры и загрузил в проект. На основе него можно увидеть, как работает алгорим.

## Конфигурационный файл
Параметры вынесены в конфигурационный файл config.py, в котором можно откорректировать настройки
```
# Путь к датасетам YOLO
YOLO_PATH = ROOT_PATH + "/resources/yolo"
YOLO_CLASS_DETECTED = ["car", "bus"]

# URL-путь к видео-потоку или сохраненное видео
VIDEO_URL = ROOT_PATH + "/resources/video/video_3.mp4"

# Анализ и сохранение параметров происходит каждого 10 фрейма
ALG_PERIODIC_FRAME = 10
# Путь сохранения картинки с разменными найденными объектами
ALG_RESULT_PHOTO_PATH = ROOT_PATH + "/web/public/result/out_result.jpg"

# Путь к БД sqlite
DB_PATH = ROOT_PATH + "/traffic_db.db"
```

## Тесты
Реализованы UnitTest-ы для проверки корректности выполнения DAO-методов